# Audio Analyzer

A Rust tool that analyzes audio files to extract beat timestamps and amplitude envelope data for the Sound Wave Surfer game.

## Features

- **Beat Detection**: Uses spectral flux analysis to detect beats in audio files
- **Amplitude Envelope Extraction**: Generates time-series amplitude data for audio-reactive visualization
- **Multiple Format Support**: MP3, WAV, AAC, and more via Symphonia

## Installation

Make sure you have Rust installed. If not, get it from [rustup.rs](https://rustup.rs/).

```bash
cd audio-analyzer
cargo build --release
```

## Usage

### Quick Scripts (Recommended)

**Windows:**
```powershell
.\analyze.bat ..\assets\music.mp3
```

**Linux/macOS:**
```bash
chmod +x analyze.sh  # First time only
./analyze.sh ../assets/music.mp3
```

**Cross-platform (Python):**
```bash
python analyze.py ../assets/music.mp3
```

**Cross-platform (Make):**
```bash
make analyze FILE=../assets/music.mp3
```

### Manual Usage

Analyze an audio file directly with cargo:

```bash
cargo run --release -- --input ../assets/music.mp3
```

This will generate two files in the same directory as the input:
- `music.beats.txt` - Beat timestamps
- `music.wave.dat` - Amplitude envelope data

### Custom Output Directory

```bash
cargo run --release -- --input ../assets/music.mp3 --output ../assets/
```

### Adjust Beat Detection Sensitivity

The `--threshold` parameter controls how sensitive beat detection is (0.0-1.0):

```bash
# More sensitive (detects more beats)
cargo run --release -- --input ../assets/music.mp3 --threshold 0.2

# Less sensitive (only strong beats)
cargo run --release -- --input ../assets/music.mp3 --threshold 0.5
```

**Default**: 0.3 (works well for most music)

### Adjust Amplitude Sample Rate

The `--sample-rate` parameter controls how many amplitude samples per second (Hz):

```bash
# Higher resolution (smoother wave animation, larger file)
cargo run --release -- --input ../assets/music.mp3 --sample-rate 120

# Lower resolution (choppier wave, smaller file)
cargo run --release -- --input ../assets/music.mp3 --sample-rate 30
```

**Default**: 60 Hz (good balance)

## Output Files

### Beat File (`.beats.txt`)

Plain text file with one timestamp per line (in seconds):

```
# Beat timestamps (in seconds)
# Generated by audio-analyzer
# Total beats: 42

0.600
1.200
1.800
2.400
...
```

### Wave File (`.wave.dat`)

CSV format with time,amplitude pairs:

```
# Amplitude envelope data (time,amplitude)
# Generated by audio-analyzer
# Total samples: 1200

0.000,0.1234
0.017,0.2456
0.033,0.4567
...
```

Amplitudes are normalized to 0.0-1.0 range.

## Integration with LÃ–VE2D

The game automatically loads these files when you load music:

1. Place your audio file in `assets/` (e.g., `assets/music.mp3`)
2. Run the analyzer: `cd audio-analyzer && cargo run --release -- --input ../assets/music.mp3`
3. The generated `.beats.txt` and `.wave.dat` files will be created automatically
4. Run the game - it will detect and load the analyzed data!

The game will print messages like:
```
Loaded beat markers from: assets/music.beats.txt
Loaded 1200 amplitude samples from: assets/music.wave.dat
Wave is now audio-reactive!
```

## Troubleshooting

### No beats detected

Try lowering the threshold:
```bash
cargo run --release -- --input ../assets/music.mp3 --threshold 0.2
```

### Too many false beats

Try raising the threshold:
```bash
cargo run --release -- --input ../assets/music.mp3 --threshold 0.4
```

### Wave animation too choppy

Increase the sample rate:
```bash
cargo run --release -- --input ../assets/music.mp3 --sample-rate 120
```

## How It Works

### Beat Detection

1. Converts audio to mono and loads all samples
2. Applies FFT (Fast Fourier Transform) in overlapping windows
3. Calculates spectral flux (energy increase in frequency domain)
4. Finds peaks in spectral flux above the threshold
5. Filters out beats that are too close together (< 100ms)

### Amplitude Envelope

1. Divides audio into windows based on target sample rate
2. Calculates RMS (Root Mean Square) energy for each window
3. Normalizes to 0-1 range
4. Outputs as time-series data

## Dependencies

- `symphonia` - Audio decoding
- `rustfft` - FFT implementation
- `clap` - CLI argument parsing

